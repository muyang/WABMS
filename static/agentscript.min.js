(function(){var Agent,AgentSet,Agents,Animator,Color,ColorMap,DataColorMap,Evented,Link,Links,Model,Patch,Patches,Shapes,Util,shapes,u,util,__hasProp={}.hasOwnProperty,__indexOf=[].indexOf||function(t){for(var n=0,e=this.length;e>n;n++)if(n in this&&this[n]===t)return n;return-1},__slice=[].slice,__extends=function(t,n){function e(){this.constructor=t}for(var r in n)__hasProp.call(n,r)&&(t[r]=n[r]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t},__bind=function(t,n){return function(){return t.apply(n,arguments)}};Util=util=u={error:function(t){throw new Error(t)},MaxINT:Math.pow(2,53),MinINT:-Math.pow(2,53),MaxINT32:2147483647,MinINT32:-2147483648,isArray:Array.isArray||function(t){return!(!(t&&t.concat&&t.unshift)||t.callee)},isFunction:function(t){return!!(t&&t.constructor&&t.call&&t.apply)},isString:function(t){return!!(""===t||t&&t.charCodeAt&&t.substr)},randomSeed:function(t){return null==t&&(t=123456),Math.random=function(){var n;return n=1e4*Math.sin(t++),n-Math.floor(n)}},randomInt:function(t){return Math.floor(Math.random()*t)},randomInt2:function(t,n){return t+Math.floor(Math.random()*(n-t))},randomNormal:function(t,n){var e,r,i;return null==t&&(t=0),null==n&&(n=1),r=1-Math.random(),i=Math.random(),e=Math.sqrt(-2*Math.log(r))*Math.cos(2*Math.PI*i),e*n+t},randomFloat:function(t){return Math.random()*t},randomFloat2:function(t,n){return t+Math.random()*(n-t)},randomCentered:function(t){return this.randomFloat2(-t/2,t/2)},log10:function(t){return Math.log(t)/Math.LN10},log2:function(t){return this.logN(t,2)},logN:function(t,n){return Math.log(t)/Math.log(n)},mod:function(t,n){return(t%n+n)%n},wrap:function(t,n,e){return n+this.mod(t-n,e-n)},clamp:function(t,n,e){return Math.max(Math.min(t,e),n)},sign:function(t){return 0>t?-1:1},fixed:function(t,n){return null==n&&(n=2),n=Math.pow(10,n),Math.round(t*n)/n},aToFixed:function(t,n){var e,r,i,o;for(null==n&&(n=2),o=[],r=0,i=t.length;i>r;r++)e=t[r],o.push(e.toFixed(n));return o},tls:function(t){return t.toLocaleString()},randomColor:function(t){var n,e;for(null==t&&(t=[]),null!=t.str&&(t.str=null),n=e=0;2>=e;n=++e)t[n]=this.randomInt(256);return t},randomGray:function(t,n,e){var r,i,o;if(null==t&&(t=[]),null==n&&(n=64),null==e&&(e=192),2===arguments.length)return this.randomGray(null,t,n);for(null!=t.str&&(t.str=null),i=this.randomInt2(n,e),r=o=0;2>=o;r=++o)t[r]=i;return t},randomMapColor:function(t,n){return null==t&&(t=[]),null==n&&(n=[0,63,127,191,255]),this.setColor(t,this.oneOf(n),this.oneOf(n),this.oneOf(n))},randomBrightColor:function(t){return null==t&&(t=[]),this.randomMapColor(t,[0,127,255])},randomHSBColor:function(t){return null==t&&(t=[]),t=this.hsbToRgb([5*this.randomInt(51),255,255])},setColor:function(t,n,e,r,i){return null!=t.str&&(t.str=null),t[0]=n,t[1]=e,t[2]=r,null!=i&&(t[3]=i),t},setGray:function(t,n,e){return this.setColor(t,n,n,n,e)},scaleColor:function(t,n,e){var r,i,o,s;for(null==e&&(e=[]),null!=e.str&&(e.str=null),r=o=0,s=t.length;s>o;r=++o)i=t[r],e[r]=this.clamp(Math.round(i*n),0,255);return e},scaleOpacity:function(t,n,e){return null==e&&(e=u.clone(t)),null!=e.str&&(e.str=null),3===t.length&&t.push(1),e[3]=this.clamp(t[3]*n,0,1).toFixed(3),e},colorStr:function(t){var n;return null!=(n=t.str)?n:(4===t.length&&t[3]>1&&this.error("alpha > 1"),t.str=3===t.length?"rgb("+t+")":"rgba("+t+")")},colorsEqual:function(t,n){return t.toString()===n.toString()},rgbToGray:function(t){return.2126*t[0]+.7152*t[1]+.0722*t[2]},rgbToHsb:function(t){var n,e,r,i,o,s,a,u,h;if(a=t[0]/255,r=t[1]/255,n=t[2]/255,o=Math.max(a,r,n),s=Math.min(a,r,n),h=o,i=0,e=o-s,u=0===o?0:e/o,o!==s)switch(o){case a:i=(r-n)/e+(n>r?6:0);break;case r:i=(n-a)/e+2;break;case n:i=(a-r)/e+4}return[Math.round(255*i/6),Math.round(255*u),Math.round(255*h)]},hsbToRgb:function(t){var n,e,r,i,o,s,a,u,h,l,c;switch(i=t[0]/255,h=t[1]/255,c=t[2]/255,o=Math.floor(6*i),e=6*i-o,s=c*(1-h),a=c*(1-e*h),l=c*(1-(1-e)*h),o%6){case 0:u=c,r=l,n=s;break;case 1:u=a,r=c,n=s;break;case 2:u=s,r=c,n=l;break;case 3:u=s,r=a,n=c;break;case 4:u=l,r=s,n=c;break;case 5:u=c,r=s,n=a}return[Math.round(255*u),Math.round(255*r),Math.round(255*n)]},rgbMap:function(t,n,e){var r,i,o,s,a,u,h,l,c,p,f;for(null==n&&(n=t),null==e&&(e=t),"number"==typeof t&&(t=function(){var n,e;for(e=[],o=n=0;t>=0?t>n:n>t;o=t>=0?++n:--n)e.push(Math.round(255*o/(t-1)));return e}()),"number"==typeof n&&(n=function(){var t,e;for(e=[],o=t=0;n>=0?n>t:t>n;o=n>=0?++t:--t)e.push(Math.round(255*o/(n-1)));return e}()),"number"==typeof e&&(e=function(){var t,n;for(n=[],o=t=0;e>=0?e>t:t>e;o=e>=0?++t:--t)n.push(Math.round(255*o/(e-1)));return n}()),s=[],u=0,c=t.length;c>u;u++)for(a=t[u],h=0,p=n.length;p>h;h++)for(i=n[h],l=0,f=e.length;f>l;l++)r=e[l],s.push([a,i,r]);return s},grayMap:function(){var t,n,e;for(e=[],t=n=0;255>=n;t=++n)e.push([t,t,t]);return e},hsbMap:function(t,n,e){var r,i,o;for(null==t&&(t=256),null==n&&(n=255),null==e&&(e=255),o=[],r=i=0;t>=0?t>i:i>t;r=t>=0?++i:--i)o.push(this.hsbToRgb([255*r/(t-1),n,e]));return o},gradientMap:function(t,n,e){var r,i,o,s,a,u,h,l,c;for(null==e&&(e=function(){var t,e,r;for(r=[],o=t=0,e=n.length;e>=0?e>t:t>e;o=e>=0?++t:--t)r.push(o/(n.length-1));return r}()),r=this.createCtx(t,1),i=r.createLinearGradient(0,0,t,0),o=a=0,h=n.length;h>=0?h>a:a>h;o=h>=0?++a:--a)i.addColorStop(e[o],this.colorStr(n[o]));for(r.fillStyle=i,r.fillRect(0,0,t,1),s=this.ctxToImageData(r).data,c=[],o=u=0,l=s.length;l>u;o=u+=4)c.push([s[o],s[o+1],s[o+2]]);return c},isLittleEndian:function(){var t;return t=new Uint32Array([16909060]),4===new Uint8ClampedArray(t.buffer)[0]},degToRad:function(t){return t*Math.PI/180},radToDeg:function(t){return 180*t/Math.PI},subtractRads:function(t,n){var e,r;return r=t-n,e=Math.PI,-e>=r&&(r+=2*e),r>e&&(r-=2*e),r},ownKeys:function(t){var n,e,r;r=[];for(n in t)__hasProp.call(t,n)&&(e=t[n],r.push(n));return r},ownVarKeys:function(t){var n,e,r;r=[];for(n in t)__hasProp.call(t,n)&&(e=t[n],this.isFunction(e)||r.push(n));return r},ownValues:function(t){var n,e,r;r=[];for(n in t)__hasProp.call(t,n)&&(e=t[n],r.push(e));return r},cloneObject:function(t){var n,e,r;e={};for(n in t)__hasProp.call(t,n)&&(r=t[n],e[n]=t[n]);return t.__proto__!==Object.prototype&&(console.log("cloneObject, setting proto"),e.__proto__=t.__proto__),e},cloneClass:function(oldClass,newName){var ctorStr;return ctorStr=oldClass.toString().replace(/^/,"var ctor = "),newName&&(ctorStr=ctorStr.replace(/function.*{/,"function "+newName+"() {")),eval(ctorStr),ctor.prototype=this.cloneObject(oldClass.prototype),ctor.constructor=oldClass.constructor,ctor.prototype.constructor=oldClass.prototype.constructor,ctor},mixin:function(t,n){var e,r,i;for(e in n)__hasProp.call(n,e)&&(t[e]=n[e]);r=n.__proto__,i=[];for(e in r)__hasProp.call(r,e)&&i.push(t.__proto__[e]=n.__proto__[e]);return i},parseToPrimitive:function(t){var n;try{return JSON.parse(t)}catch(e){return n=e,decodeURIComponent(t)}},parseQueryString:function(t){var n,e,r,i,o,s;for(null==t&&(t=window.location.search.substring(1)),n={},s=t.split("&"),i=0,o=s.length;o>i;i++)e=s[i],0!==t.length&&(r=e.split("="),n[r[0]]=1===r.length?!0:this.parseToPrimitive(r[1]));return n},any:function(t){return 0!==t.length},empty:function(t){return 0===t.length},clone:function(t,n,e){var r;return r=null!=t.slice?"slice":"subarray",null!=n?t[r](n,e):t[r](0)},last:function(t){return this.empty(t)&&this.error("last: empty array"),t[t.length-1]},oneOf:function(t){return this.empty(t)&&this.error("oneOf: empty array"),t[this.randomInt(t.length)]},nOf:function(t,n){var e,r;for(n=Math.min(t.length,Math.floor(n)),r=[];r.length<n;)e=this.oneOf(t),__indexOf.call(r,e)<0&&r.push(e);return r},contains:function(t,n,e){return this.indexOf(t,n,e)>=0},removeItem:function(t,n,e){var r;return(r=this.indexOf(t,n,e))<0?this.error("removeItem: item not found"):t.splice(r,1)},removeItems:function(t,n,e){var r,i,o;for(i=0,o=n.length;o>i;i++)r=n[i],this.removeItem(t,r,e);return t},insertItem:function(t,n,e){var r;return r=this.sortedIndex(t,n,e),t[r]===n&&error("insertItem: item already in array"),t.splice(r,0,n)},shuffle:function(t){return t.sort(function(){return.5-Math.random()})},minOneOf:function(t,n,e){var r,i,o,s,a,u;for(null==n&&(n=this.identity),null==e&&(e=!1),this.empty(t)&&this.error("minOneOf: empty array"),o=1/0,i=null,this.isString(n)&&(n=this.propFcn(n)),a=0,u=t.length;u>a;a++)r=t[a],(s=n(r))<o&&(o=s,i=r);return e?[i,o]:i},maxOneOf:function(t,n,e){var r,i,o,s,a,u;for(null==n&&(n=this.identity),null==e&&(e=!1),this.empty(t)&&this.error("maxOneOf: empty array"),o=-1/0,i=null,this.isString(n)&&(n=this.propFcn(n)),a=0,u=t.length;u>a;a++)r=t[a],(s=n(r))>o&&(o=s,i=r);return e?[i,o]:i},firstOneOf:function(t,n){var e,r,i,o;for(r=i=0,o=t.length;o>i;r=++i)if(e=t[r],n(e))return r;return-1},histOf:function(t,n,e){var r,i,o,s,a,u,h,l,c;for(null==n&&(n=1),null==e&&(e=function(t){return t}),o=[],this.isString(e)&&(e=this.propFcn(e)),u=0,l=t.length;l>u;u++)r=t[u],i=Math.floor(e(r)/n),o[i]=null!=(s=o[i])?s+1:1;for(i=h=0,c=o.length;c>h;i=++h)a=o[i],null==a&&(o[i]=0);return o},sortBy:function(t,n){return this.isString(n)&&(n=this.propFcn(n)),t.sort(function(t,e){return n(t)-n(e)})},sortNums:function(t,n){var e;return null==n&&(n=!0),e=n?function(t,n){return t-n}:function(t,n){return n-t},null!=t.sort?t.sort(e):Array.prototype.sort.call(t,e)},uniq:function(t){var n,e,r;if(t.length<2)return t;for(n=e=r=t.length-1;e>=1;n=e+=-1)t[n-1]===t[n]&&t.splice(n,1);return t},flatten:function(t){return t.reduce(function(t,n){return t.concat(n)})},aProp:function(t,n){var e,r,i,o,s,a,u;if("function"==typeof n){for(a=[],r=0,o=t.length;o>r;r++)e=t[r],a.push(n(e));return a}for(u=[],i=0,s=t.length;s>i;i++)e=t[i],u.push(e[n]);return u},aToObj:function(t,n){var e,r,i,o;for(e=i=0,o=n.length;o>i;e=++i)r=n[e],t[r]=t[e];return t},aMax:function(t){var n,e,r,i;for(e=t[0],r=0,i=t.length;i>r;r++)n=t[r],e=Math.max(e,n);return e},aMin:function(t){var n,e,r,i;for(e=t[0],r=0,i=t.length;i>r;r++)n=t[r],e=Math.min(e,n);return e},aSum:function(t){var n,e,r,i;for(e=0,r=0,i=t.length;i>r;r++)n=t[r],e+=n;return e},aAvg:function(t){return this.aSum(t)/t.length},aMid:function(t){return t=null!=t.sort?this.clone(t):this.typedToJS(t),this.sortNums(t),t[Math.floor(t.length/2)]},aStats:function(t){var n,e,r,i;return i=this.aMin(t),e=this.aMax(t),n=this.aAvg(t),r=this.aMid(t),{min:i,max:e,avg:n,mid:r}},aNaNs:function(t){var n,e,r,i,o;for(o=[],n=r=0,i=t.length;i>r;n=++r)e=t[n],isNaN(e)&&o.push(n);return o},aRange:function(t,n,e){var r,i,o;for(null==e&&(e=1),o=[],r=i=t;e>0?n>=i:i>=n;r=i+=e)o.push(r);return o},aRamp:function(t,n,e){var r,i,o,s;for(i=(n-t)/(e-1),s=[],r=o=0;e>=0?e>o:o>e;r=e>=0?++o:--o)s.push(t+i*r);return s},aIntRamp:function(t,n,e){var r,i,o,s,a;for(s=this.aRamp(t,n,e),a=[],i=0,o=s.length;o>i;i++)r=s[i],a.push(Math.round(r));return a},aPairwise:function(t,n,e){var r,i,o,s,a;for(i=0,a=[],r=o=0,s=t.length;s>o;r=++o)i=t[r],a.push(e(i,n[r]));return a},aPairSum:function(t,n){return this.aPairwise(t,n,function(t,n){return t+n})},aPairDif:function(t,n){return this.aPairwise(t,n,function(t,n){return t-n})},aPairMul:function(t,n){return this.aPairwise(t,n,function(t,n){return t*n})},typedToJS:function(t){var n,e,r,i;for(i=[],e=0,r=t.length;r>e;e++)n=t[e],i.push(n);return i},lerp:function(t,n,e){return n>=t?t+(n-t)*e:t-(t-n)*e},lerpScale:function(t,n,e){return(t-n)/(e-n)},lerp2:function(t,n,e,r,i){return[this.lerp(t,e,i),this.lerp(n,r,i)]},normalize:function(t,n,e){var r,i,o,s,a,u,h;for(null==n&&(n=0),null==e&&(e=1),i=this.aMin(t),r=this.aMax(t),s=1/(r-i),h=[],a=0,u=t.length;u>a;a++)o=t[a],h.push(this.lerp(n,e,s*(o-i)));return h},normalize8:function(t){return new Uint8ClampedArray(this.normalize(t,-.5,255.5))},normalizeInt:function(t,n,e){var r,i,o,s,a;for(s=this.normalize(t,n,e),a=[],i=0,o=s.length;o>i;i++)r=s[i],a.push(Math.round(r));return a},sortedIndex:function(t,n,e){var r,i,o,s;for(null==e&&(e=function(t){return t}),this.isString(e)&&(e=this.propFcn(e)),s=e(n),i=0,r=t.length;r>i;)o=i+r>>>1,e(t[o])<s?i=o+1:r=o;return i},identity:function(t){return t},propFcn:function(t){return function(n){return n[t]}},indexOf:function(t,n,e){var r;return null!=e?(r=this.sortedIndex(t,n,""===e?null:e),t[r]===n?r:-1):t.indexOf(n)},radsToward:function(t,n,e,r){return Math.atan2(r-n,e-t)},inCone:function(t,n,e,r,i,o,s){var a;return e<this.distance(r,i,o,s)?!1:(a=this.radsToward(r,i,o,s),n/2>=Math.abs(this.subtractRads(t,a)))},distance:function(t,n,e,r){var i,o;return i=t-e,o=n-r,Math.sqrt(i*i+o*o)},sqDistance:function(t,n,e,r){var i,o;return i=t-e,o=n-r,i*i+o*o},polarToXY:function(t,n,e,r){return null==e&&(e=0),null==r&&(r=0),[e+t*Math.cos(n),r+t*Math.sin(n)]},torusDistance:function(t,n,e,r,i,o){return Math.sqrt(this.torusSqDistance(t,n,e,r,i,o))},torusSqDistance:function(t,n,e,r,i,o){var s,a,u,h;return s=Math.abs(e-t),u=Math.abs(r-n),a=Math.min(s,i-s),h=Math.min(u,o-u),a*a+h*h},torusWraps:function(t,n,e,r,i,o){var s,a;return s=Math.abs(e-t),a=Math.abs(r-n),s>i-s||a>o-a},torus4Pts:function(t,n,e,r,i,o){var s,a;return s=t>e?e+i:e-i,a=n>r?r+o:r-o,[[e,r],[s,r],[e,a],[s,a]]},torusPt:function(t,n,e,r,i,o){var s,a,u,h;return a=t>e?e+i:e-i,h=n>r?r+o:r-o,s=Math.abs(a-t)<Math.abs(e-t)?a:e,u=Math.abs(h-n)<Math.abs(r-n)?h:r,[s,u]},torusRadsToward:function(t,n,e,r,i,o){var s;return s=this.torusPt(t,n,e,r,i,o),e=s[0],r=s[1],this.radsToward(t,n,e,r)},inTorusCone:function(t,n,e,r,i,o,s,a,u){var h,l,c,p;for(p=this.torus4Pts(r,i,o,s,a,u),l=0,c=p.length;c>l;l++)if(h=p[l],this.inCone(t,n,e,r,i,h[0],h[1]))return!0;return!1},fileIndex:{},importImage:function(t,n){var e;return null==n&&(n=function(){}),null!=(e=this.fileIndex[t])?n(e):(this.fileIndex[t]=e=new Image,e.isDone=!1,e.crossOrigin="Anonymous",e.onload=function(){return n(e),e.isDone=!0},e.src=t),e},xhrLoadFile:function(t,n,e,r){var i;return null==n&&(n="GET"),null==e&&(e="text"),null==r&&(r=function(){}),null!=(i=this.fileIndex[t])?r(i.response):(this.fileIndex[t]=i=new XMLHttpRequest,i.isDone=!1,i.open(n,t),i.responseType=e,i.onload=function(){return r(i.response),i.isDone=!0},i.send()),i},filesLoaded:function(t){var n,e;return null==t&&(t=this.fileIndex),n=function(){var n,r,i,o;for(i=this.ownValues(t),o=[],n=0,r=i.length;r>n;n++)e=i[n],o.push(e.isDone);return o}.call(this),n.reduce(function(t,n){return t&&n},!0)},waitOnFiles:function(t,n){return null==n&&(n=this.fileIndex),this.waitOn(function(t){return function(){return t.filesLoaded(n)}}(this),t)},waitOn:function(t,n){return t()?n():setTimeout(function(e){return function(){return e.waitOn(t,n)}}(this),1e3)},cloneImage:function(t){var n;return(n=new Image).src=t.src,n},imageToData:function(t,n,e){return null==n&&(n=this.pixelByte(0)),null==e&&(e=Uint8ClampedArray),this.imageRowsToData(t,t.height,n,e)},imageRowsToData:function(t,n,e,r){var i,o,s,a,u,h,l,c,p;for(null==e&&(e=this.pixelByte(0)),null==r&&(r=Uint8ClampedArray),l=0,o=new r(t.width*t.height);l<t.height;){for(h=Math.min(t.height-l,n),i=this.imageSliceToCtx(t,0,l,t.width,h),u=this.ctxToImageData(i).data,s=l*t.width,a=c=0,p=u.length/4;p>c;a=c+=1)o[s+a]=e(u,4*a);l+=h}return o},pixelBytesToInt:function(t){var n;return n=[[2],[1,2],[0,1,2],[3,0,1,2]],"number"==typeof t&&(t=n[t-1]),function(n,e){var r,i,o,s;for(i=0,o=0,s=t.length;s>o;o++)r=t[o],i=256*i+n[e+r];return i}},pixelByte:function(t){return function(n,e){return n[e+t]}},createCanvas:function(t,n){var e;return e=document.createElement("canvas"),e.width=t,e.height=n,e},createCtx:function(t,n,e){var r,i;return null==e&&(e="2d"),r=this.createCanvas(t,n),"2d"===e?r.getContext("2d"):null!=(i=r.getContext("webgl"))?i:r.getContext("experimental-webgl")},createLayer:function(t,n,e,r,i){var o;return null==i&&(i="2d"),"img"===i?(o=i=new Image,i.width=n,i.height=e):o=(i=this.createCtx(n,e,i)).canvas,this.insertLayer(t,o,n,e,r),i},insertLayer:function(t,n,e,r,i){return n.setAttribute("style","position:absolute;top:0;left:0;width:"+e+";height:"+r+";z-index:"+i),t.appendChild(n)},setCtxSmoothing:function(t,n){return t.imageSmoothingEnabled=n,t.mozImageSmoothingEnabled=n,t.oImageSmoothingEnabled=n,t.webkitImageSmoothingEnabled=n},setIdentity:function(t){return t.save(),t.setTransform(1,0,0,1,0,0)},clearCtx:function(t){return null!=t.save?(this.setIdentity(t),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.restore()):(t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))},fillCtx:function(t,n){return null!=t.fillStyle?(this.setIdentity(t),t.fillStyle=this.colorStr(n),t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore()):(t.clearColor.apply(t,__slice.call(n).concat([1])),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))},ctxDrawText:function(t,n,e,r,i,o){return null==i&&(i=[0,0,0]),null==o&&(o=!0),o&&this.setIdentity(t),t.fillStyle=this.colorStr(i),t.fillText(n,e,r),o?t.restore():void 0},ctxTextParams:function(t,n,e,r){return null==e&&(e="center"),null==r&&(r="middle"),t.font=n,t.textAlign=e,t.textBaseline=r},elementTextParams:function(t,n,e,r){return null==e&&(e="center"),null==r&&(r="middle"),null!=t.canvas&&(t=t.canvas),t.style.font=n,t.style.textAlign=e,t.style.textBaseline=r},imageToCtx:function(t,n,e){var r;return null!=n&&null!=e?(r=this.createCtx(n,e),r.drawImage(t,0,0,n,e)):(r=this.createCtx(t.width,t.height),r.drawImage(t,0,0)),r},imageSliceToCtx:function(t,n,e,r,i,o){return null!=o?(o.canvas.width=r,o.canvas.height=i):o=this.createCtx(r,i),o.drawImage(t,n,e,r,i,0,0,r,i),o},imageToCtxDownStepped:function(t,n,e){var r,i,o,s,a,u,h,l,c;if(o=this.createCtx(n,e),l=t.width,s=t.height,a=function(t){return Math.ceil(t/2)},h=Math.ceil(this.log2(l/n>s/e?l/n:s/e)),console.log("steps",h),1>=h)o.drawImage(t,0,0,n,e);else{for(console.log("img w/h",l,s,"->",a(l),a(s)),i=this.createCtx(l=a(l),s=a(s)),r=i.canvas,i.drawImage(t,0,0,l,s),u=c=h;2>=h?2>c:c>2;u=2>=h?++c:--c)console.log("can w/h",l,s,"->",a(l),a(s)),i.drawImage(r,0,0,l,s,0,0,l=a(l),s=a(s));console.log("target w/h",l,s,"->",n,e),o.drawImage(r,0,0,l,s,0,0,n,e)}return o},ctxToDataUrl:function(t){return t.canvas.toDataURL("image/png")},ctxToDataUrlImage:function(t,n){var e;return e=new Image,null!=n&&(e.onload=function(){return n(e)}),e.src=t.canvas.toDataURL("image/png"),e},ctxToImageData:function(t){return t.getImageData(0,0,t.canvas.width,t.canvas.height)},drawCenteredImage:function(t,n,e,r,i,o,s){return t.translate(r,i),t.rotate(e),t.drawImage(n,-o/2,-s/2)},copyCtx:function(t){var n;return n=this.createCtx(t.canvas.width,t.canvas.height),n.drawImage(t.canvas,0,0),n},resizeCtx:function(t,n,e,r){var i;return null==r&&(r=!1),i=this.copyCtx(t),t.canvas.width=n,t.canvas.height=e,t.drawImage(i.canvas,0,0)}},Evented=function(){function t(){this.events={}}return t.prototype.emit=function(){var t,n,e,r,i,o,s;if(e=arguments[0],t=2<=arguments.length?__slice.call(arguments,1):[],this.events[e]){for(o=this.events[e],s=[],r=0,i=o.length;i>r;r++)n=o[r],s.push(n.apply(null,t));return s}},t.prototype.on=function(t,n){var e;return(null!=(e=this.events)[t]?e[t]:e[t]=[]).push(n)},t.prototype.off=function(t,n){var e;return this.events[t]?n?this.events[t]=function(){var r,i,o,s;for(o=this.events[t],s=[],r=0,i=o.length;i>r;r++)e=o[r],e!==n&&s.push(e);return s}.call(this):delete this.events[t]:void 0},t}(),window.c=Color={rgbString:function(t,n,e,r){if(null==r&&(r=1),r>1)throw new Error("alpha > 1");return 1===r?"rgb("+t+","+n+","+e+")":"rgba("+t+","+n+","+e+","+r+")"},hslString:function(t,n,e,r){if(null==r&&(r=1),r>1)throw new Error("alpha > 1");return 1===r?"hsl("+t+","+n+"%,"+e+"%)":"hsla("+t+","+n+"%,"+e+"%,"+r+")"},rgbIntensity:function(t,n,e){return.2126*t+.7152*n+.0722*e},rgbToHex:function(t,n,e){return"#"+(16777216|(e|n<<8|t<<16)).toString(16).slice(-6)},rgbToPixel:function(t,n,e,r,i){var o,s;return null==r&&(r=255),null==i&&(i=!1),s=new Uint8ClampedArray([t,n,e,r]),o=new Uint32Array(s.buffer)[0],i?[o,s]:o},pixelToRgb:function(t){var n;return n=new Uint32Array([t]),new Uint8ClampedArray(n.buffer)},sharedCtx1x1:u.createCtx(1,1),stringToRgb:function(t){var n,e,r,i,o;return t=t.toLowerCase(),this.sharedCtx1x1.clearRect(0,0,1,1),this.sharedCtx1x1.fillStyle=t,this.sharedCtx1x1.fillRect(0,0,1,1),t=t.replace(/\ */g,""),o=this.sharedCtx1x1.getImageData(0,0,1,1).data,i=o[0],r=o[1],e=o[2],n=o[3],i+r+e!==0||"#000"===t||"#000000"===t||"transparent"===t||"black"===t||t.match(/rgba{0,1}\(0,0,0/)||t.match(/hsla{0,1}\([^,]*,[^,]*,0%/)?[i,r,e]:null},roundToInt:function(t,n){var e;return null==n&&(n=255),t>=0&&1>=t||console.log("roundToInt: float "+t+", max "+n),e=Math.round(n*t),e>=0&&n>=e||console.log("roundToInt: int "+e+", max "+n),u.clamp(e,0,n)},rgbToHsl:function(t,n,e){var r,i,o,s,a,u,h;if(t/=255,n/=255,e/=255,s=Math.max(t,n,e),a=Math.min(t,n,e),h=s+a,r=s-a,o=h/2,s===a)i=u=0;else switch(u=o>.5?r/(2-h):r/h,s){case t:i=(n-e)/r+(e>n?6:0);break;case n:i=(e-t)/r+2;break;case e:i=(t-n)/r+4}return[this.roundToInt(i/6,360),this.roundToInt(u,100),this.roundToInt(o,100)]},hslToRgb:function(t,n,e){var r;return r=this.hslString(t,n,e),this.stringToRgb(r)},randomRgbColor:function(){var t,n,e;for(e=[],t=n=0;2>=n;t=++n)e.push(u.randomInt(256));return e},rgbDistance:function(t,n,e,r,i,o){var s,a,u,h,l;return h=Math.round((t+r)/2),l=[t-r,n-i,e-o],u=l[0],a=l[1],s=l[2],Math.sqrt(((512+h)*u*u>>8)+4*a*a+((767-h)*s*s>>8))},rgbLerp:function(t,n,e,r,i){var o,s,a,h;for(null==i&&(i=[0,0,0]),s=u.lerpScale(t,n,e),h=[],o=a=0;2>=a;o=++a)h.push(Math.round(u.lerp(i[o],r[o],s)));return h},options:function(){return{hsl:!0,pixel:!0,intensity:!0,rgbString:!0,hexString:!0}},colorObject:function(t,n,e,r,i){var o,s;return null==r&&(r=1),null==i&&(i=this.options()),o={r:t,g:n,b:e,a:r},o.hsl&&(s=this.rgbToHsl(t,n,e),o.h=s[0],o.s=s[1],o.l=s[2]),i.pixel&&(o.a255=Math.round(255*r),o.pixel=this.rgbToPixel(t,n,e,o.a255)),i.intensity&&(o.intensity=this.rgbIntensity(t,n,e)),i.rgbString&&(o.rgbString=this.rgbString(t,n,e,r)),i.hexString&&(o.hexString=this.rgbToHex(t,n,e)),o},colorObjToRgb:function(t){return 1===t.a?[t.r,t.g,t.b]:[t.r,t.g,t.b,t.a]},randomColorObject:function(t,n){return null==t&&(t=1),null==n&&(n=this.options()),this.colorObject.apply(this,__slice.call(this.randomRgbColor()).concat([t],[n]))},DataColorMap:DataColorMap=function(t){function n(t,e){var r,i,o;for(null==e&&(e=function(t){return t}),n.__super__.constructor.call(this,0),i=0,o=t.length;o>i;i++)r=t[i],this.push(e(r))}return __extends(n,t),n.prototype.randomIndex=function(){return u.randomInt(this.length)},n.prototype.randomColor=function(){return this[this.randomIndex()]},n.prototype.scaleIndex=function(t,n,e,r,i){var o;return null==r&&(r=0),null==i&&(i=this.length-1),o=u.lerpScale(t,n,e),Math.round(u.lerp(r,i,o))},n.prototype.scaleColor=function(t,n,e,r,i){return null==r&&(r=0),null==i&&(i=this.length-1),this[this.scaleIndex(t,n,e,r,i)]},n}(Array),ColorMap:ColorMap=function(t){function n(t,e,r){var i,o,s,a;for(this.options=null!=e?e:Color.options(),this.dupsOK=null!=r?r:!1,n.__super__.constructor.call(this,0),this.index={},i=s=0,a=t.length;a>s;i=++s)o=t[i],this.addColor.apply(this,o)}return __extends(n,t),n.prototype.addColor=function(t,n,e,r){var i,o;return null==r&&(r=1),o=Color.rgbString(t,n,e,r),this.dupsOK||(i=this.index[o],i&&console.log("dup color",i)),i||(i=Color.colorObject(t,n,e,r,this.options),i.ix=this.length,i.map=this,this.index[o]=i,this.push(i)),i},n.prototype.sort=function(t){var e,r,i,o;for(n.__super__.sort.call(this,t),r=i=0,o=this.length;o>i;r=++i)e=this[r],e.ix=r;return this},n.prototype.sortBy=function(t,n){var e;return null==n&&(n=!0),e=function(e,r){return n?e[t]-r[t]:r[t]-e[t]},this.sort(e)},n.prototype.findRgb=function(t,n,e,r){return null==r&&(r=1),this.index[Color.rgbString(t,n,e,r)]},n.prototype.findKey=function(t,n){var e,r,i,o;for(r=i=0,o=this.length;o>i;r=++i)if(e=this[r],e[t]===n)return e;return void 0},n.prototype.randomIndex=function(){return u.randomInt(this.length)},n.prototype.randomColor=function(){return this[this.randomIndex()]},n.prototype.scaleColor=function(t,n,e,r,i){var o,s;return null==r&&(r=0),null==i&&(i=this.length-1),s=u.lerpScale(t,n,e),o=Math.round(u.lerp(r,i,s)),this[o]},n.prototype.findClosest=function(t,n,e){var r,i,o,s,a,u,h;if(r=this.findRgb(t,n,e))return r;for(a=1/0,s=0,o=u=0,h=this.length;h>u;o=++u)r=this[o],i=Color.rgbDistance(r.r,r.g,r.b,t,n,e),a>i&&(a=i,s=o);return this[s]},n}(Array),grayValueArray:function(t){return null==t&&(t=256),t>256&&u.error("Color: gray value > 256"),u.aIntRamp(0,255,t)},grayColorArray:function(t){var n,e,r,i,o;for(null==t&&(t=256),i=this.grayValueArray(t),o=[],e=0,r=i.length;r>e;e++)n=i[e],o.push([n,n,n]);return o},grayColorMap:function(t,n){return null==t&&(t=256),new ColorMap(this.grayColorArray(t),n,!1)},permuteColors:function(t,n,e,r){var i,o,s,a,h,l,c,p,f,d,g,m,y,x;for(null==e&&(e=n),null==r&&(r=e),c=t?[255,255,255]:[359,100,100],x=function(){var t,o,s,a;for(s=[n,e,r],a=[],l=t=0,o=s.length;o>t;l=++t)i=s[l],a.push("number"==typeof i?1===i?[c[l]]:u.aIntRamp(0,c[l],i):i);return a}(),n=x[0],e=x[1],r=x[2],h=[],p=0,g=r.length;g>p;p++)for(a=r[p],f=0,m=e.length;m>f;f++)for(s=e[f],d=0,y=n.length;y>d;d++)o=n[d],h.push([o,s,a]);return h},rgbColorArray:function(t,n,e){return null==n&&(n=t),null==e&&(e=t),this.permuteColors(!0,t,n,e)},rgbColorMap:function(t,n,e,r,i){var o;return null==n&&(n=t),null==e&&(e=t),o=new ColorMap(this.rgbColorArray(t,n,e),r,i)},hslColorArray:function(t,n,e){return null==n&&(n=1),null==e&&(e=1),this.permuteColors(!1,t,n,e)},hslColorMap:function(t,n,e,r,i){var o,s,a;return null==n&&(n=1),null==e&&(e=1),s=this.hslColorArray(t,n,e),a=function(){var t,n,e;for(e=[],t=0,n=s.length;n>t;t++)o=s[t],e.push(this.hslToRgb.apply(this,o));return e}.call(this),new ColorMap(a,r,i)},gradientColorArray:function(t,n,e){var r,i,o,s,a,h,l,c,p;for(null==e&&(e=function(){var t,e,r;for(r=[],o=t=0,e=n.length;e>=0?e>t:t>e;o=e>=0?++t:--t)r.push(o/(n.length-1));return r}()),r=u.createCtx(t,1),i=r.createLinearGradient(0,0,t,0),o=a=0,l=n.length;l>=0?l>a:a>l;o=l>=0?++a:--a)i.addColorStop(e[o],this.rgbString.apply(this,n[o]));for(r.fillStyle=i,r.fillRect(0,0,t,1),s=u.ctxToImageData(r).data,p=[],o=h=0,c=s.length;c>h;o=h+=4)p.push([s[o],s[o+1],s[o+2]]);return p},gradientColorMap:function(t,n,e,r,i){return new ColorMap(this.gradientColorArray(t,n,e),r,i)},nameColorMap:function(t,n,e){var r,i,o,s,a,u,h,l,c,p;for(null==e&&(e=!0),h=function(){var n;n=[];for(o in t)l=t[o],n.push(l);return n}(),u=function(){var n;n=[];for(o in t)l=t[o],n.push(o);return n}(),s=new ColorMap(h,n,e),i=c=0,p=s.length;p>c;i=++c)r=s[i],a=u[i],s.index[a]=r;return s},randomColorArray:function(t){var n,e,r;for(r=[],n=e=0;t>=0?t>e:e>t;n=t>=0?++e:--e)r.push(this.randomRgbColor());return r},randomColorMap:function(t,n,e){return new ColorMap(this.randomColorArray(t),n,e)}},shapes=Shapes=function(){var t,n,e,r,i,o,s;return o=function(t,n){var e,r,i,o;for(e=i=0,o=n.length;o>i;e=++i)r=n[e],0===e?t.moveTo(r[0],r[1]):t.lineTo(r[0],r[1]);return null},e=function(t,n,e,r){return t.arc(n,e,r/2,0,2*Math.PI)},t=function(t,n,e,r){return t.arc(n,e,r/2,0,2*Math.PI,!0)},n=function(t,n,e,r,i){return t.scale(1,-1),t.drawImage(i,n-r/2,e-r/2,r,r),t.scale(1,-1)},r=function(t,n,e,r){return t.fillRect(n-r/2,e-r/2,r,r)},i=function(t,n){return t.ctx.save(),t.ctx.scale(1,-1),t.ctx.drawImage(n,t.x,-(t.y+t.spriteSize),t.spriteSize,t.spriteSize),t.ctx.restore()},s=[],{"default":{rotate:!0,draw:function(t){return o(t,[[.5,0],[-.5,-.5],[-.25,0],[-.5,.5]])}},triangle:{rotate:!0,draw:function(t){return o(t,[[.5,0],[-.5,-.4],[-.5,.4]])}},arrow:{rotate:!0,draw:function(t){return o(t,[[.5,0],[0,.5],[0,.2],[-.5,.2],[-.5,-.2],[0,-.2],[0,-.5]])}},bug:{rotate:!0,draw:function(t){return t.strokeStyle=t.fillStyle,t.lineWidth=.05,o(t,[[.4,.225],[.2,0],[.4,-.225]]),t.stroke(),t.beginPath(),e(t,.12,0,.26),e(t,-.05,0,.26),e(t,-.27,0,.4)}},pyramid:{rotate:!1,draw:function(t){return o(t,[[0,.5],[-.433,-.25],[.433,-.25]])}},circle:{shortcut:function(t,n,r,i){return t.beginPath(),e(t,n,r,i),t.closePath(),t.fill()},rotate:!1,draw:function(t){return e(t,0,0,1)}},square:{shortcut:function(t,n,e,i){return r(t,n,e,i)},rotate:!1,draw:function(t){return r(t,0,0,1)}},pentagon:{rotate:!1,draw:function(t){return o(t,[[0,.45],[-.45,.1],[-.3,-.45],[.3,-.45],[.45,.1]])}},ring:{rotate:!1,draw:function(n){return e(n,0,0,1),n.closePath(),t(n,0,0,.6)}},filledRing:{rotate:!1,draw:function(t){var n;return e(t,0,0,1),n=t.fillStyle,t.fillStyle=t.strokeStyle,t.fill(),t.fillStyle=n,t.beginPath(),e(t,0,0,.8)}},person:{rotate:!1,draw:function(t){return o(t,[[.15,.2],[.3,0],[.125,-.1],[.125,.05],[.1,-.15],[.25,-.5],[.05,-.5],[0,-.25],[-.05,-.5],[-.25,-.5],[-.1,-.15],[-.125,.05],[-.125,-.1],[-.3,0],[-.15,.2]]),t.closePath(),e(t,0,.35,.3)}},names:function(){var t,n,e;e=[];for(t in this)__hasProp.call(this,t)&&(n=this[t],null!=n.rotate&&null!=n.draw&&e.push(t));return e},add:function(t,e,r,i){var o;return o=this[t]=u.isFunction(r)?{rotate:e,draw:r}:{rotate:e,img:r,draw:function(t){return n(t,.5,.5,1,this.img)}},null==o.img||o.rotate||(o.shortcut=function(t,e,r,i){return n(t,e,r,i,this.img)}),null!=i?o.shortcut=i:void 0},poly:o,circ:e,ccirc:t,cimg:n,csq:r,spriteSheets:s,draw:function(t,n,e,r,i,o,s,a){return null!=n.shortcut?(null==n.img&&(t.fillStyle=u.colorStr(s)),n.shortcut(t,e,r,i)):(t.save(),t.translate(e,r),1!==i&&t.scale(i,i),0!==o&&t.rotate(o),null!=n.img?n.draw(t):(t.fillStyle=u.colorStr(s),a&&(t.strokeStyle=u.colorStr(a),t.lineWidth=.05),t.save(),t.beginPath(),n.draw(t),t.closePath(),t.restore(),t.fill(),a&&t.stroke()),t.restore()),n},drawSprite:function(t,n,e,r,i,o){return 0===o?t.drawImage(n.ctx.canvas,n.x,n.y,n.spriteSize,n.spriteSize,e-i/2,r-i/2,i,i):(t.save(),t.translate(e,r),t.rotate(o),t.drawImage(n.ctx.canvas,n.x,n.y,n.spriteSize,n.spriteSize,-i/2,-i/2,i,i),t.restore()),n},shapeToSprite:function(t,n,e,r){var o,a,h,l,c,p,f,d,g,m,y;return d=Math.ceil(e),g=4,f=d+g,c=this[t],l=null!=c.img?t:""+t+"-"+u.colorStr(n),o=s[f],null==o&&(s[f]=o=u.createCtx(10*f,f),o.nextX=0,o.nextY=0,o.index={}),null!=(a=o.index[l])?a:(f*o.nextX===o.canvas.width&&(u.resizeCtx(o,o.canvas.width,o.canvas.height+f),o.nextX=0,o.nextY++),m=f*o.nextX+g/2,y=f*o.nextY+g/2,p={ctx:o,x:m,y:y,size:e,spriteSize:d,name:t,color:n,strokeColor:r,index:l},o.index[l]=p,null!=(h=c.img)?0!==h.height?i(p,h):h.onload=function(){return i(p,h)}:(o.save(),o.translate((o.nextX+.5)*f,(o.nextY+.5)*f),o.scale(d,d),o.fillStyle=u.colorStr(n),r&&(o.strokeStyle=u.colorStr(r),o.lineWidth=.05),o.save(),o.beginPath(),c.draw(o),o.closePath(),o.restore(),o.fill(),r&&o.stroke(),o.restore()),o.nextX++,p)}}}(),AgentSet=function(_super){function AgentSet(t,n,e,r){this.model=t,this.agentClass=n,this.name=e,this.mainSet=r,AgentSet.__super__.constructor.call(this,0),null==this.mainSet&&(this.breeds=[]),this.agentClass.prototype.breed=this,this.agentClass.prototype.model=this.model,this.ownVariables=[],null==this.mainSet&&(this.ID=0)}return __extends(AgentSet,_super),AgentSet.asSet=function(t,n){var e;return null==n&&(n=AgentSet),t.__proto__=null!=(e=n.prototype)?e:n.constructor.prototype,null!=t[0]&&(t.model=t[0].model),t},AgentSet.prototype.create=function(){},AgentSet.prototype.add=function(t){return null!=this.mainSet?this.mainSet.add(t):t.id=this.ID++,this.push(t),t},AgentSet.prototype.remove=function(t){return null!=this.mainSet&&u.removeItem(this.mainSet,t),u.removeItem(this,t),this},AgentSet.prototype.setDefault=function(t,n){return this.agentClass.prototype[t]=n,this},AgentSet.prototype.own=function(t){var n,e,r,i;for(i=t.split(" "),e=0,r=i.length;r>e;e++)n=i[e],this.setDefault(n,null),this.ownVariables.push(n);return this},AgentSet.prototype.setBreed=function(t){var n,e,r;null!=t.breed.mainSet&&u.removeItem(t.breed,t,"id"),null!=this.mainSet&&u.insertItem(this,t,"id"),e=t.__proto__=this.agentClass.prototype;for(n in t)__hasProp.call(t,n)&&(r=t[n],null!=e[n]&&delete t[n]);return t},AgentSet.prototype.exclude=function(t){var n;return t=t.split(" "),this.asSet(function(){var e,r,i,o;for(o=[],e=0,r=this.length;r>e;e++)n=this[e],i=n.breed.name,__indexOf.call(t,i)<0&&o.push(n);return o}.call(this))},AgentSet.prototype.floodFill=function(t,n,e,r,i){var o,s;for(null==i&&(i=[]),o=this.floodFillOnce(t,n,e,r,i),s=[];o;)s.push(o=o());
return s},AgentSet.prototype.floodFillOnce=function(t,n,e,r,i){var o,s,a,u,h,l,c,p,f,d;for(null==i&&(i=[]),u=0,c=t.length;c>u;u++)a=t[u],e(a,i);for(o=[],h=0,p=t.length;p>h;h++)for(a=t[h],d=r(a),l=0,f=d.length;f>l;l++)s=d[l],n(s,t)&&o.indexOf(s)<0&&o.push(s);return 0===o.length?null:function(i){return function(){return i.floodFillOnce(o,n,e,r,t)}}(this)},AgentSet.prototype.uniq=function(){return u.uniq(this)},AgentSet.prototype.asSet=function(t,n){return null==n&&(n=this),AgentSet.asSet(t,n)},AgentSet.prototype.asOrderedSet=function(t){return this.asSet(t).sortById()},AgentSet.prototype.toString=function(){var t;return"["+function(){var n,e,r;for(r=[],n=0,e=this.length;e>n;n++)t=this[n],r.push(t.toString());return r}.call(this).join(", ")+"]"},AgentSet.prototype.getProp=function(t){return u.aProp(this,t)},AgentSet.prototype.getPropWith=function(t,n){var e;return this.asSet(function(){var r,i,o;for(o=[],r=0,i=this.length;i>r;r++)e=this[r],e[t]===n&&o.push(e);return o}.call(this))},AgentSet.prototype.setProp=function(t,n){var e,r,i,o,s,a;if(u.isArray(n)){for(e=i=0,s=this.length;s>i;e=++i)r=this[e],r[t]=n[e];return this}for(o=0,a=this.length;a>o;o++)r=this[o],r[t]=n;return this},AgentSet.prototype.maxProp=function(t){return u.aMax(this.getProp(t))},AgentSet.prototype.minProp=function(t){return u.aMin(this.getProp(t))},AgentSet.prototype.histOfProp=function(t,n){return null==n&&(n=1),u.histOf(this,n,t)},AgentSet.prototype.shuffle=function(){return u.shuffle(this)},AgentSet.prototype.sortById=function(){return u.sortBy(this,"id")},AgentSet.prototype.clone=function(){return this.asSet(u.clone(this))},AgentSet.prototype.last=function(){return u.last(this)},AgentSet.prototype.any=function(){return u.any(this)},AgentSet.prototype.other=function(t){var n;return this.asSet(function(){var e,r,i;for(i=[],e=0,r=this.length;r>e;e++)n=this[e],n!==t&&i.push(n);return i}.call(this))},AgentSet.prototype.oneOf=function(){return u.oneOf(this)},AgentSet.prototype.nOf=function(t){return this.asSet(u.nOf(this,t))},AgentSet.prototype.minOneOf=function(t,n){return null==n&&(n=!1),u.minOneOf(this,t,n)},AgentSet.prototype.maxOneOf=function(t,n){return null==n&&(n=!1),u.maxOneOf(this,t,n)},AgentSet.prototype.draw=function(t){var n,e,r;for(u.clearCtx(t),e=0,r=this.length;r>e;e++)n=this[e],n.hidden||n.draw(t);return null},AgentSet.prototype.show=function(){var t,n,e;for(n=0,e=this.length;e>n;n++)t=this[n],t.hidden=!1;return this.draw(this.model.contexts[this.name])},AgentSet.prototype.hide=function(){var t,n,e;for(n=0,e=this.length;e>n;n++)t=this[n],t.hidden=!0;return this.draw(this.model.contexts[this.name])},AgentSet.prototype.inRadius=function(t,n,e){var r,i,o,s,a,h;return null==e&&(e=!1),i=n*n,a=t.x,h=t.y,this.model.patches.isTorus?(s=this.model.patches.numX,o=this.model.patches.numY,this.asSet(function(){var n,l,c;for(c=[],n=0,l=this.length;l>n;n++)r=this[n],u.torusSqDistance(a,h,r.x,r.y,s,o)<=i&&(e||r!==t)&&c.push(r);return c}.call(this))):this.asSet(function(){var n,o,s;for(s=[],n=0,o=this.length;o>n;n++)r=this[n],u.sqDistance(a,h,r.x,r.y)<=i&&(e||r!==t)&&s.push(r);return s}.call(this))},AgentSet.prototype.inCone=function(t,n,e,r,i){var o,s,a,h,l,c;return null==i&&(i=!1),a=this.inRadius(t,r,i),l=t.x,c=t.y,this.model.patches.isTorus?(h=this.model.patches.numX,s=this.model.patches.numY,this.asSet(function(){var p,f,d;for(d=[],p=0,f=a.length;f>p;p++)o=a[p],(o===t&&i||u.inTorusCone(n,e,r,l,c,o.x,o.y,h,s))&&d.push(o);return d}())):this.asSet(function(){var s,h,p;for(p=[],s=0,h=a.length;h>s;s++)o=a[s],(o===t&&i||u.inCone(n,e,r,l,c,o.x,o.y))&&p.push(o);return p}())},AgentSet.prototype.ask=function(f){var o,_i,_len;for(u.isString(f)&&eval("f=function(o){return "+f+";}"),_i=0,_len=this.length;_len>_i;_i++)o=this[_i],f(o);return this},AgentSet.prototype["with"]=function(f){var o;return u.isString(f)&&eval("f=function(o){return "+f+";}"),this.asSet(function(){var t,n,e;for(e=[],t=0,n=this.length;n>t;t++)o=this[t],f(o)&&e.push(o);return e}.call(this))},AgentSet}(Array),Patch=function(){function t(t,n){this.x=t,this.y=n}return t.prototype.id=null,t.prototype.breed=null,t.prototype.x=null,t.prototype.y=null,t.prototype.n=null,t.prototype.n4=null,t.prototype.color=[0,0,0],t.prototype.hidden=!1,t.prototype.label=null,t.prototype.labelColor=[0,0,0],t.prototype.labelOffset=[0,0],t.prototype.pRect=null,t.prototype.toString=function(){return"{id:"+this.id+" xy:"+[this.x,this.y]+" c:"+this.color+"}"},t.prototype.scaleColor=function(t,n){return this.hasOwnProperty("color")||(this.color=u.clone(this.color)),u.scaleColor(t,n,this.color)},t.prototype.scaleOpacity=function(t,n){return this.hasOwnProperty("color")||(this.color=u.clone(this.color)),u.scaleOpacity(t,n,this.color)},t.prototype.draw=function(t){var n,e,r;return t.fillStyle=u.colorStr(this.color),t.fillRect(this.x-.5,this.y-.5,1,1),null!=this.label?(r=this.breed.patchXYtoPixelXY(this.x,this.y),n=r[0],e=r[1],u.ctxDrawText(t,this.label,n+this.labelOffset[0],e+this.labelOffset[1],this.labelColor)):void 0},t.prototype.agentsHere=function(){var t,n;return null!=(n=this.agents)?n:function(){var n,e,r,i;for(r=this.model.agents,i=[],n=0,e=r.length;e>n;n++)t=r[n],t.p===this&&i.push(t);return i}.call(this)},t.prototype.isOnEdge=function(){return this.x===this.breed.minX||this.x===this.breed.maxX||this.y===this.breed.minY||this.y===this.breed.maxY},t.prototype.sprout=function(t,n,e){return null==t&&(t=1),null==n&&(n=this.model.agents),null==e&&(e=function(){}),n.create(t,function(t){return function(n){return n.setXY(t.x,t.y),e(n),n}}(this))},t}(),Patches=function(t){function n(){var t,e,r;n.__super__.constructor.apply(this,arguments),this.monochrome=!1,r=this.model.world;for(t in r)__hasProp.call(r,t)&&(e=r[t],this[t]=e);null==this.mainSet&&this.populate()}return __extends(n,t),n.prototype.populate=function(){var t,n,e,r,i,o,s,a;for(n=e=i=this.maxY,o=this.minY;e>=o;n=e+=-1)for(t=r=s=this.minX,a=this.maxX;a>=r;t=r+=1)this.add(new this.agentClass(t,n));return this.hasNeighbors&&this.setNeighbors(),this.isHeadless?void 0:this.setPixels()},n.prototype.cacheAgentsHere=function(){var t,n,e;for(n=0,e=this.length;e>n;n++)t=this[n],t.agents=[];return null},n.prototype.usePixels=function(t){var n;return this.drawWithPixels=null!=t?t:!0,n=this.model.contexts.patches,u.setCtxSmoothing(n,!this.drawWithPixels)},n.prototype.cacheRect=function(t,n){var e,r,i;for(null==n&&(n=!1),r=0,i=this.length;i>r;r++)e=this[r],e.pRect=this.patchRect(e,t,t,n),e.pRect.radius=t;return t},n.prototype.setNeighbors=function(){var t,n,e,r,i;for(i=[],e=0,r=this.length;r>e;e++)n=this[e],n.n=this.patchRect(n,1,1),i.push(n.n4=this.asSet(function(){var e,r,i,o;for(i=n.n,o=[],e=0,r=i.length;r>e;e++)t=i[e],(t.x===n.x||t.y===n.y)&&o.push(t);return o}()));return i},n.prototype.setPixels=function(){return 1===this.size?(this.usePixels(),this.pixelsCtx=this.model.contexts.patches):this.pixelsCtx=u.createCtx(this.numX,this.numY),this.pixelsImageData=this.pixelsCtx.getImageData(0,0,this.numX,this.numY),this.pixelsData=this.pixelsImageData.data,this.pixelsData instanceof Uint8Array?(this.pixelsData32=new Uint32Array(this.pixelsData.buffer),this.pixelsAreLittleEndian=u.isLittleEndian()):void 0},n.prototype.draw=function(t){return this.monochrome?u.fillCtx(t,this.agentClass.prototype.color):this.drawWithPixels?this.drawScaledPixels(t):n.__super__.draw.call(this,t)},n.prototype.patchIndex=function(t,n){return t-this.minX+this.numX*(this.maxY-n)},n.prototype.patchXY=function(t,n){return this[this.patchIndex(t,n)]},n.prototype.clamp=function(t,n){return[u.clamp(t,this.minXcor,this.maxXcor),u.clamp(n,this.minYcor,this.maxYcor)]},n.prototype.wrap=function(t,n){return[u.wrap(t,this.minXcor,this.maxXcor),u.wrap(n,this.minYcor,this.maxYcor)]},n.prototype.coord=function(t,n){return this.isTorus?this.wrap(t,n):this.clamp(t,n)},n.prototype.isOnWorld=function(t,n){return this.isTorus||this.minXcor<=t&&t<=this.maxXcor&&this.minYcor<=n&&n<=this.maxYcor},n.prototype.patch=function(t,n){var e;return e=this.coord(t,n),t=e[0],n=e[1],t=u.clamp(Math.round(t),this.minX,this.maxX),n=u.clamp(Math.round(n),this.minY,this.maxY),this.patchXY(t,n)},n.prototype.randomPt=function(){return[u.randomFloat2(this.minXcor,this.maxXcor),u.randomFloat2(this.minYcor,this.maxYcor)]},n.prototype.toBits=function(t){return t*this.size},n.prototype.fromBits=function(t){return t/this.size},n.prototype.patchRect=function(t,n,e,r){var i,o,s,a,h,l,c,p,f,d;if(null==r&&(r=!1),null!=t.pRect&&t.pRect.radius===n)return t.pRect;for(o=[],a=h=c=t.y-e,p=t.y+e;p>=h;a=h+=1)for(s=l=f=t.x-n,d=t.x+n;d>=l;s=l+=1)(this.isTorus||this.minX<=s&&s<=this.maxX&&this.minY<=a&&a<=this.maxY)&&(this.isTorus&&(s<this.minX&&(s+=this.numX),s>this.maxX&&(s-=this.numX),a<this.minY&&(a+=this.numY),a>this.maxY&&(a-=this.numY)),i=this.patchXY(s,a),null==i&&(u.error("patchRect: x,y out of bounds, see console.log"),console.log("x "+s+" y "+a+" p.x "+t.x+" p.y "+t.y+" dx "+n+" dy "+e)),(r||t!==i)&&o.push(i));return this.asSet(o)},n.prototype.importDrawing=function(t,n){return u.importImage(t,function(t){return function(e){return t.installDrawing(e),null!=n?n():void 0}}(this))},n.prototype.installDrawing=function(t,n){return null==n&&(n=this.model.contexts.drawing),u.setIdentity(n),n.drawImage(t,0,0,n.canvas.width,n.canvas.height),n.restore()},n.prototype.pixelByteIndex=function(t){return 4*t.id},n.prototype.pixelWordIndex=function(t){return t.id},n.prototype.pixelXYtoPatchXY=function(t,n){return[this.minXcor+t/this.size,this.maxYcor-n/this.size]},n.prototype.patchXYtoPixelXY=function(t,n){return[(t-this.minXcor)*this.size,(this.maxYcor-n)*this.size]},n.prototype.importColors=function(t,n,e){return u.importImage(t,function(t){return function(r){return t.installColors(r,e),null!=n?n():void 0}}(this))},n.prototype.installColors=function(t,n){var e,r,i,o,s;for(u.setIdentity(this.pixelsCtx),this.pixelsCtx.drawImage(t,0,0,this.numX,this.numY),e=this.pixelsCtx.getImageData(0,0,this.numX,this.numY).data,o=0,s=this.length;s>o;o++)i=this[o],r=this.pixelByteIndex(i),i.color=null!=n?n[r]:[e[r++],e[r++],e[r]];return this.pixelsCtx.restore()},n.prototype.drawScaledPixels=function(t){return 1!==this.size&&u.setIdentity(t),null!=this.pixelsData32?this.drawScaledPixels32(t):this.drawScaledPixels8(t),1!==this.size?t.restore():void 0},n.prototype.drawScaledPixels8=function(t){var n,e,r,i,o,s,a,u,h;for(r=this.pixelsData,a=0,h=this.length;h>a;a++){for(s=this[a],i=this.pixelByteIndex(s),e=s.color,n=4===e.length?e[3]:255,o=u=0;2>=u;o=++u)r[i+o]=e[o];r[i+3]=n}return this.pixelsCtx.putImageData(this.pixelsImageData,0,0),1!==this.size?t.drawImage(this.pixelsCtx.canvas,0,0,t.canvas.width,t.canvas.height):void 0},n.prototype.drawScaledPixels32=function(t){var n,e,r,i,o,s,a;for(r=this.pixelsData32,s=0,a=this.length;a>s;s++)o=this[s],i=this.pixelWordIndex(o),e=o.color,n=4===e.length?e[3]:255,r[i]=this.pixelsAreLittleEndian?n<<24|e[2]<<16|e[1]<<8|e[0]:e[0]<<24|e[1]<<16|e[2]<<8|n;return this.pixelsCtx.putImageData(this.pixelsImageData,0,0),1!==this.size?t.drawImage(this.pixelsCtx.canvas,0,0,t.canvas.width,t.canvas.height):void 0},n.prototype.floodFillOnce=function(t,e,r,i,o){return null==i&&(i=function(t){return t.n}),null==o&&(o=[]),n.__super__.floodFillOnce.call(this,t,e,r,i,o)},n.prototype.diffuse=function(t,n,e){var r,i,o,s,a,u,h,l,c,p,f,d,g,m;if(null==this[0]._diffuseNext)for(u=0,p=this.length;p>u;u++)a=this[u],a._diffuseNext=0;for(h=0,f=this.length;f>h;h++)for(a=this[h],r=a[t]*n,i=r/8,s=a.n.length,a._diffuseNext+=a[t]-r+(8-s)*i,m=a.n,l=0,d=m.length;d>l;l++)o=m[l],o._diffuseNext+=i;for(c=0,g=this.length;g>c;c++)a=this[c],a[t]=a._diffuseNext,a._diffuseNext=0,e&&a.scaleColor(e,a[t]);return null},n}(AgentSet),Agent=function(){function t(){this.x=this.y=0,this.p=this.model.patches.patch(this.x,this.y),null==this.color&&(this.color=u.randomColor()),null==this.heading&&(this.heading=u.randomFloat(2*Math.PI)),null!=this.p.agents&&this.p.agents.push(this),this.cacheLinks&&(this.links=[])}return t.prototype.id=null,t.prototype.breed=null,t.prototype.x=0,t.prototype.y=0,t.prototype.p=null,t.prototype.size=1,t.prototype.color=null,t.prototype.strokeColor=null,t.prototype.shape="default",t.prototype.hidden=!1,t.prototype.label=null,t.prototype.labelColor=[0,0,0],t.prototype.labelOffset=[0,0],t.prototype.penDown=!1,t.prototype.penSize=1,t.prototype.heading=null,t.prototype.sprite=null,t.prototype.cacheLinks=!1,t.prototype.links=null,t.prototype.scaleColor=function(t,n){return this.hasOwnProperty("color")||(this.color=u.clone(this.color)),u.scaleColor(t,n,this.color)},t.prototype.scaleOpacity=function(t,n){return this.hasOwnProperty("color")||(this.color=u.clone(this.color)),u.scaleOpacity(t,n,this.color)},t.prototype.toString=function(){var t;return"{id:"+this.id+" xy:"+u.aToFixed([this.x,this.y])+" c:"+this.color+" h: "+(t=this.heading.toFixed(2))+"/"+Math.round(u.radToDeg(t))+"}"},t.prototype.setXY=function(t,n){var e,r,i,o,s,a;return this.penDown&&(s=[this.x,this.y],i=s[0],o=s[1]),a=this.model.patches.coord(t,n),this.x=a[0],this.y=a[1],r=this.p,this.p=this.model.patches.patch(this.x,this.y),null!=r.agents&&r!==this.p&&(u.removeItem(r.agents,this),this.p.agents.push(this)),this.penDown?(e=this.model.drawing,e.strokeStyle=u.colorStr(this.color),e.lineWidth=this.model.patches.fromBits(this.penSize),e.beginPath(),e.moveTo(i,o),e.lineTo(t,n),e.stroke()):void 0},t.prototype.moveTo=function(t){return this.setXY(t.x,t.y)},t.prototype.forward=function(t){return this.setXY(this.x+t*Math.cos(this.heading),this.y+t*Math.sin(this.heading))},t.prototype.rotate=function(t){return this.heading=u.wrap(this.heading+t,0,2*Math.PI)},t.prototype.right=function(t){return this.rotate(-t)},t.prototype.left=function(t){return this.rotate(t)},t.prototype.draw=function(t){var n,e,r,i,o;return e=Shapes[this.shape],n=e.rotate?this.heading:0,null!=this.sprite||this.breed.useSprites?(null==this.sprite&&this.setSprite(),Shapes.drawSprite(t,this.sprite,this.x,this.y,this.size,n)):Shapes.draw(t,e,this.x,this.y,this.size,n,this.color,this.strokeColor),null!=this.label?(o=this.model.patches.patchXYtoPixelXY(this.x,this.y),r=o[0],i=o[1],u.ctxDrawText(t,this.label,r+this.labelOffset[0],i+this.labelOffset[1],this.labelColor)):void 0},t.prototype.setSprite=function(t){var n;return null!=(n=t)?(this.sprite=n,this.color=n.color,this.strokeColor=n.strokeColor,this.shape=n.shape,this.size=n.size):(null==this.color&&(this.color=u.randomColor),this.sprite=Shapes.shapeToSprite(this.shape,this.color,this.model.patches.toBits(this.size),this.strokeColor))},t.prototype.stamp=function(){return this.draw(this.model.drawing)},t.prototype.distanceXY=function(t,n){return this.model.patches.isTorus?u.torusDistance(this.x,this.y,t,n,this.model.patches.numX,this.model.patches.numY):u.distance(this.x,this.y,t,n)},t.prototype.distance=function(t){return this.distanceXY(t.x,t.y)},t.prototype.torusPtXY=function(t,n){return u.torusPt(this.x,this.y,t,n,this.model.patches.numX,this.model.patches.numY)},t.prototype.torusPt=function(t){return this.torusPtXY(t.x,t.y)},t.prototype.face=function(t){return this.heading=this.towards(t)},t.prototype.towardsXY=function(t,n){var e;return(e=this.model.patches).isTorus?u.torusRadsToward(this.x,this.y,t,n,e.numX,e.numY):u.radsToward(this.x,this.y,t,n)},t.prototype.towards=function(t){return this.towardsXY(t.x,t.y)},t.prototype.patchAtHeadingAndDistance=function(t,n){var e,r,i;return i=u.polarToXY(n,t+this.heading),e=i[0],r=i[1],this.patchAt(e,r)},t.prototype.patchLeftAndAhead=function(t,n){return this.patchAtHeadingAndDistance(t,n)},t.prototype.patchRightAndAhead=function(t,n){return this.patchAtHeadingAndDistance(-t,n)},t.prototype.patchAhead=function(t){return this.patchAtHeadingAndDistance(0,t)},t.prototype.canMove=function(t){return null!=this.patchAhead(t)},t.prototype.patchAt=function(t,n){var e,r,i;return r=this.x+t,i=this.y+n,(e=this.model.patches).isOnWorld(r,i)?e.patch(r,i):null},t.prototype.die=function(){var t,n,e;for(this.breed.remove(this),e=this.myLinks(),n=e.length-1;n>=0;n+=-1)t=e[n],t.die();return null!=this.p.agents&&u.removeItem(this.p.agents,this),null},t.prototype.hatch=function(t,n,e){return null==t&&(t=1),null==n&&(n=this.model.agents),null==e&&(e=function(){}),n.create(t,function(t){return function(n){var r,i;n.setXY(t.x,t.y);for(r in t)__hasProp.call(t,r)&&(i=t[r],"id"!==r&&(n[r]=i));return e(n),n}}(this))},t.prototype.inCone=function(t,n,e,r){return null==r&&(r=!1),t.inCone(this.p,this.heading,n,e,r)},t.prototype.otherEnd=function(t){return t.end1===this?t.end2:t.end1},t.prototype.myLinks=function(){var t,n;return null!=(n=this.links)?n:function(){var n,e,r,i;for(r=this.model.links,i=[],n=0,e=r.length;e>n;n++)t=r[n],(t.end1===this||t.end2===this)&&i.push(t);return i}.call(this)},t.prototype.linkNeighbors=function(){var t,n,e,r,i;for(r=this.myLinks(),i=[],n=0,e=r.length;e>n;n++)t=r[n],i.push(this.otherEnd(t));return i},t.prototype.myInLinks=function(){var t,n,e,r,i;for(r=this.myLinks(),i=[],n=0,e=r.length;e>n;n++)t=r[n],t.end2===this&&i.push(t);return i},t.prototype.inLinkNeighbors=function(){var t,n,e,r,i;for(r=this.myLinks(),i=[],n=0,e=r.length;e>n;n++)t=r[n],t.end2===this&&i.push(t.end1);return i},t.prototype.myOutLinks=function(){var t,n,e,r,i;for(r=this.myLinks(),i=[],n=0,e=r.length;e>n;n++)t=r[n],t.end1===this&&i.push(t);return i},t.prototype.outLinkNeighbors=function(){var t,n,e,r,i;for(r=this.myLinks(),i=[],n=0,e=r.length;e>n;n++)t=r[n],t.end1===this&&i.push(t.end2);return i},t}(),Agents=function(t){function n(){n.__super__.constructor.apply(this,arguments),this.useSprites=!1}return __extends(n,t),n.prototype.cacheLinks=function(){return this.agentClass.prototype.cacheLinks=!0},n.prototype.setUseSprites=function(t){this.useSprites=null!=t?t:!0},n.prototype["in"]=function(t){var n;return this.asSet(function(){var e,r,i;for(i=[],e=0,r=t.length;r>e;e++)n=t[e],n.breed===this&&i.push(n);return i}.call(this))},n.prototype.create=function(t,n){var e,r,i;for(null==n&&(n=function(){}),i=[],e=r=1;t>=r;e=r+=1)i.push(function(t){return n(t),t}(this.add(new this.agentClass)));return i},n.prototype.clear=function(){for(;this.any();)this.last().die();return null},n.prototype.inPatches=function(t){var n,e,r,i;for(n=[],r=0,i=t.length;i>r;r++)e=t[r],n.push.apply(n,e.agentsHere());return null!=this.mainSet?this["in"](n):this.asSet(n)},n.prototype.inRect=function(t,n,e,r){var i;return null==r&&(r=!1),i=this.model.patches.patchRect(t.p,n,e,!0),i=this.inPatches(i),r||u.removeItem(i,t),i},n.prototype.inCone=function(t,e,r,i,o){var s;return null==o&&(o=!1),s=this.inRect(t,i,i,!0),n.__super__.inCone.call(this,t,e,r,i,o)},n.prototype.inRadius=function(t,e,r){var i;return null==r&&(r=!1),i=this.inRect(t,e,e,!0),n.__super__.inRadius.call(this,t,e,r)},n}(AgentSet),Link=function(){function t(t,n){this.end1=t,this.end2=n,null!=this.end1.links&&(this.end1.links.push(this),this.end2.links.push(this))}return t.prototype.id=null,t.prototype.breed=null,t.prototype.end1=null,t.prototype.end2=null,t.prototype.color=[130,130,130],t.prototype.thickness=2,t.prototype.hidden=!1,t.prototype.label=null,t.prototype.labelColor=[0,0,0],t.prototype.labelOffset=[0,0],t.prototype.draw=function(t){var n,e,r,i,o,s,a;return t.save(),t.strokeStyle=u.colorStr(this.color),t.lineWidth=this.model.patches.fromBits(this.thickness),t.beginPath(),this.model.patches.isTorus?(n=this.end1.torusPt(this.end2),t.moveTo(this.end1.x,this.end1.y),t.lineTo.apply(t,n),(n[0]!==this.end2.x||n[1]!==this.end2.y)&&(n=this.end2.torusPt(this.end1),t.moveTo(this.end2.x,this.end2.y),t.lineTo.apply(t,n))):(t.moveTo(this.end1.x,this.end1.y),t.lineTo(this.end2.x,this.end2.y)),t.closePath(),t.stroke(),t.restore(),null!=this.label?(s=u.lerp2(this.end1.x,this.end1.y,this.end2.x,this.end2.y,.5),r=s[0],o=s[1],a=this.model.patches.patchXYtoPixelXY(r,o),e=a[0],i=a[1],u.ctxDrawText(t,this.label,e+this.labelOffset[0],i+this.labelOffset[1],this.labelColor)):void 0},t.prototype.die=function(){return this.breed.remove(this),null!=this.end1.links&&u.removeItem(this.end1.links,this),null!=this.end2.links&&u.removeItem(this.end2.links,this),null},t.prototype.bothEnds=function(){return[this.end1,this.end2]},t.prototype.length=function(){return this.end1.distance(this.end2)},t.prototype.otherEnd=function(t){return this.end1===t?this.end2:this.end1},t}(),Links=function(t){function n(){n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.create=function(t,n,e){var r,i,o,s;for(null==e&&(e=function(){}),null==n.length&&(n=[n]),s=[],i=0,o=n.length;o>i;i++)r=n[i],s.push(function(t){return e(t),t}(this.add(new this.agentClass(t,r))));return s},n.prototype.clear=function(){for(;this.any();)this.last().die();return null},n.prototype.allEnds=function(){var t,n,e,r;for(n=this.asSet([]),e=0,r=this.length;r>e;e++)t=this[e],n.push(t.end1,t.end2);return n},n.prototype.nodes=function(){return this.allEnds().sortById().uniq()},n.prototype.layoutCircle=function(t,n,e,r){var i,o,s,a,u;for(null==e&&(e=Math.PI/2),null==r&&(r=-1),o=2*Math.PI/t.length,s=a=0,u=t.length;u>a;s=++a)i=t[s],i.setXY(0,0),i.heading=e+r*o*s,i.forward(n);return null},n}(AgentSet),Model=function(){function t(t,n,e,r,i,o,s,a,h){var l,c,p,f,d;if(null==n&&(n=13),null==e&&(e=-16),null==r&&(r=16),null==i&&(i=-16),null==o&&(o=16),null==s&&(s=!1),null==a&&(a=!0),null==h&&(h=!1),u.mixin(this,new Evented),"string"==typeof t?(c=t,this.setWorldDeprecated(n,e,r,i,o,s,a,h)):(c=t.div,h=t.isHeadless=t.isHeadless||null==c,this.setWorld(t)),this.contexts={},!h){(this.div=document.getElementById(c)).setAttribute("style","position:relative; width:"+this.world.pxWidth+"px; height:"+this.world.pxHeight+"px"),d=this.contextsInit;for(p in d)__hasProp.call(d,p)&&(f=d[p],this.contexts[p]=l=u.createLayer(this.div,this.world.pxWidth,this.world.pxHeight,f.z,f.ctx),null!=l.canvas&&this.setCtxTransform(l),null!=l.canvas&&(l.canvas.style.pointerEvents="none"),u.elementTextParams(l,"10px sans-serif","center","middle"));this.drawing=this.contexts.drawing,this.drawing.clear=function(t){return function(){return u.clearCtx(t.drawing)}}(this),this.contexts.spotlight.globalCompositeOperation="xor"}this.anim=new Animator(this),this.refreshLinks=this.refreshAgents=this.refreshPatches=!0,this.Patches=Patches,this.Patch=u.cloneClass(Patch),this.Agents=Agents,this.Agent=u.cloneClass(Agent),this.Links=Links,this.Link=u.cloneClass(Link),this.patches=new this.Patches(this,this.Patch,"patches"),this.agents=new this.Agents(this,this.Agent,"agents"),this.links=new this.Links(this,this.Link,"links"),this.debugging=!1,this.modelReady=!1,this.globalNames=null,this.globalNames=u.ownKeys(this),this.globalNames.set=!1,this.startup(),u.waitOnFiles(function(t){return function(){return t.modelReady=!0,t.setupAndEmit(),t.globalNames.set?void 0:t.globals()}}(this))}return t.prototype.contextsInit={patches:{z:10,ctx:"2d"},drawing:{z:20,ctx:"2d"},links:{z:30,ctx:"2d"},agents:{z:40,ctx:"2d"},spotlight:{z:50,ctx:"2d"}},t.prototype.setWorld=function(t){var n,e,r,i,o,s,a,u,h,l,c,p,f,d,g,m,y,x,v,w;w=n={size:13,minX:-16,maxX:16,minY:-16,maxY:16,isTorus:!1,hasNeighbors:!0,isHeadless:!1};for(o in t)__hasProp.call(t,o)&&(v=t[o],w[o]=v);return x=w.size,l=w.minX,s=w.maxX,p=w.minY,u=w.maxY,i=w.isTorus,e=w.hasNeighbors,r=w.isHeadless,d=s-l+1,g=u-p+1,y=d*x,m=g*x,c=l-.5,a=s+.5,f=p-.5,h=u+.5,this.world={size:x,minX:l,maxX:s,minY:p,maxY:u,minXcor:c,maxXcor:a,minYcor:f,maxYcor:h,numX:d,numY:g,pxWidth:y,pxHeight:m,isTorus:i,hasNeighbors:e,isHeadless:r}},t.prototype.setWorldDeprecated=function(t,n,e,r,i,o,s,a){var u,h,l,c,p,f,d,g;return p=e-n+1,f=i-r+1,g=p*t,d=f*t,l=n-.5,u=e+.5,c=r-.5,h=i+.5,this.world={size:t,minX:n,maxX:e,minY:r,maxY:i,minXcor:l,maxXcor:u,minYcor:c,maxYcor:h,numX:p,numY:f,pxWidth:g,pxHeight:d,isTorus:o,hasNeighbors:s,isHeadless:a}},t.prototype.setCtxTransform=function(t){return t.canvas.width=this.world.pxWidth,t.canvas.height=this.world.pxHeight,t.save(),t.scale(this.world.size,-this.world.size),t.translate(-this.world.minXcor,-this.world.maxYcor)},t.prototype.globals=function(t){return null!=t?(this.globalNames=t,this.globalNames.set=!0):this.globalNames=u.removeItems(u.ownKeys(this),this.globalNames)},t.prototype.setFastPatches=function(){return this.patches.usePixels()},t.prototype.setMonochromePatches=function(){return this.patches.monochrome=!0},t.prototype.setCacheAgentsHere=function(){return this.patches.cacheAgentsHere()},t.prototype.setCacheMyLinks=function(){return this.agents.cacheLinks()},t.prototype.setCachePatchRect=function(t,n){return null==n&&(n=!1),this.patches.cacheRect(t,n)},t.prototype.startup=function(){},t.prototype.setup=function(){},t.prototype.step=function(){},t.prototype.start=function(){return u.waitOn(function(t){return function(){return t.modelReady}}(this),function(t){return function(){return t.anim.start()}}(this)),this},t.prototype.stop=function(){return this.anim.stop()},t.prototype.once=function(){return this.anim.stopped||this.stop(),this.anim.once()},t.prototype.reset=function(t){var n,e,r;null==t&&(t=!1),console.log("reset: anim"),this.anim.reset(),console.log("reset: contexts"),r=this.contexts;for(n in r)e=r[n],null!=e.canvas&&(e.restore(),this.setCtxTransform(e));return console.log("reset: patches"),this.patches=new this.Patches(this,this.Patch,"patches"),console.log("reset: agents"),this.agents=new this.Agents(this,this.Agent,"agents"),console.log("reset: links"),this.links=new this.Links(this,this.Link,"links"),Shapes.spriteSheets.length=0,console.log("reset: setup"),this.setupAndEmit(),this.debugging&&this.setRootVars(),t?this.start():void 0},t.prototype.draw=function(t){return null==t&&(t=this.anim.stopped),(t||this.refreshPatches||1===this.anim.draws)&&this.patches.draw(this.contexts.patches),(t||this.refreshLinks||1===this.anim.draws)&&this.links.draw(this.contexts.links),(t||this.refreshAgents||1===this.anim.draws)&&this.agents.draw(this.contexts.agents),null!=this.spotlightAgent&&this.drawSpotlight(this.spotlightAgent,this.contexts.spotlight),this.emit("draw")},t.prototype.setupAndEmit=function(){return this.setup(),this.emit("setup")},t.prototype.stepAndEmit=function(){return this.step(),this.emit("step")},t.prototype.setSpotlight=function(t){return this.spotlightAgent=t,null==this.spotlightAgent?u.clearCtx(this.contexts.spotlight):void 0},t.prototype.drawSpotlight=function(t,n){return u.clearCtx(n),u.fillCtx(n,[0,0,0,.6]),n.beginPath(),n.arc(t.x,t.y,3,0,2*Math.PI,!1),n.fill()},t.prototype.createBreeds=function(t,n,e){var r,i,o,s,a,h,l,c;for(o=[],o.classes={},o.sets={},c=t.split(" "),h=0,l=c.length;l>h;h++)r=c[h],a=r.charAt(0).toUpperCase()+r.substr(1),s=u.cloneClass(n,a),i=this[r]=new e(this,s,r,n.prototype.breed),o.push(i),o.sets[r]=i,o.classes[""+r+"Class"]=s;return o},t.prototype.patchBreeds=function(t){return this.patches.breeds=this.createBreeds(t,this.Patch,this.Patches)},t.prototype.agentBreeds=function(t){return this.agents.breeds=this.createBreeds(t,this.Agent,this.Agents)},t.prototype.linkBreeds=function(t){return this.links.breeds=this.createBreeds(t,this.Link,this.Links)},t.prototype.asSet=function(t,n){return null==n&&(n=AgentSet),AgentSet.asSet(t,n)},t.prototype.debug=function(t){return this.debugging=null!=t?t:!0,u.waitOn(function(t){return function(){return t.modelReady}}(this),function(t){return function(){return t.setRootVars()}}(this)),this},t.prototype.setRootVars=function(){return window.psc=this.Patches,window.pc=this.Patch,window.ps=this.patches,window.p0=this.patches[0],window.asc=this.Agents,window.ac=this.Agent,window.as=this.agents,window.a0=this.agents[0],window.lsc=this.Links,window.lc=this.Link,window.ls=this.links,window.l0=this.links[0],window.dr=this.drawing,window.u=Util,window.cx=this.contexts,window.an=this.anim,window.gl=this.globals(),window.dv=this.div,window.app=this},t}(),this.ABM={util:util,shapes:shapes,Util:Util,Color:Color,Shapes:Shapes,AgentSet:AgentSet,Patch:Patch,Patches:Patches,Agent:Agent,Agents:Agents,Link:Link,Links:Links,Animator:Animator,Evented:Evented,Model:Model},Animator=function(){function t(t,n,e){this.model=t,this.rate=null!=n?n:30,this.multiStep=null!=e?e:t.world.isHeadless,this.animateDraws=__bind(this.animateDraws,this),this.animateSteps=__bind(this.animateSteps,this),this.isHeadless=t.world.isHeadless,this.reset()}return t.prototype.setRate=function(t,n){return this.rate=t,this.multiStep=null!=n?n:this.isHeadless,this.resetTimes()},t.prototype.start=function(){return this.stopped?(this.resetTimes(),this.stopped=!1,this.animate()):void 0},t.prototype.stop=function(){return this.stopped=!0,null!=this.animHandle&&cancelAnimationFrame(this.animHandle),null!=this.timeoutHandle&&clearTimeout(this.timeoutHandle),null!=this.intervalHandle&&clearInterval(this.intervalHandle),this.animHandle=this.timerHandle=this.intervalHandle=null},t.prototype.resetTimes=function(){return this.startMS=this.now(),this.startTick=this.ticks,this.startDraw=this.draws},t.prototype.reset=function(){return this.stop(),this.ticks=this.draws=0},t.prototype.step=function(){return this.ticks++,this.model.stepAndEmit()},t.prototype.draw=function(){return this.draws++,this.model.draw()},t.prototype.once=function(){return this.step(),this.draw()},t.prototype.now=function(){return("undefined"!=typeof performance&&null!==performance?performance:Date).now()},t.prototype.ms=function(){return this.now()-this.startMS},t.prototype.ticksPerSec=function(){var t;return 0===(t=this.ticks-this.startTick)?0:Math.round(1e3*t/this.ms())},t.prototype.drawsPerSec=function(){var t;return 0===(t=this.draws-this.startDraw)?0:Math.round(1e3*t/this.ms())},t.prototype.toString=function(){return"ticks: "+this.ticks+", draws: "+this.draws+", rate: "+this.rate+" tps/dps: "+this.ticksPerSec()+"/"+this.drawsPerSec()},t.prototype.animateSteps=function(){return this.step(),this.stopped?void 0:this.timeoutHandle=setTimeout(this.animateSteps,10)},t.prototype.animateDraws=function(){return this.isHeadless?this.ticksPerSec()<this.rate&&this.step():this.drawsPerSec()<this.rate&&(this.multiStep||this.step(),this.draw()),this.stopped?void 0:this.animHandle=requestAnimationFrame(this.animateDraws)},t.prototype.animate=function(){return this.multiStep&&this.animateSteps(),this.isHeadless&&this.multiStep?void 0:this.animateDraws()},t}()}).call(this);